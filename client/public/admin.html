<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFICRI - Administraci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/src/styles/main.css" rel="stylesheet">
    <link href="/src/styles/components/buttons.css" rel="stylesheet">
    <link href="/src/styles/components/forms.css" rel="stylesheet">
    <link href="/src/styles/components/tables.css" rel="stylesheet">
    <link href="/src/styles/layouts/admin.css" rel="stylesheet">
    <link href="/src/styles/components/sidebar.css" rel="stylesheet">
    <link href="/src/styles/pages/admin.css" rel="stylesheet">
    <link href="/src/styles/components/UserProfile.css" rel="stylesheet">
</head>
<body>
    <!-- Header / Navbar -->
    <header class="navbar navbar-dark sticky-top flex-md-nowrap p-0 shadow">
        <!-- Bot√≥n hamburguesa independiente visible en todas las resoluciones -->
        <button id="menuToggle" class="ms-2">
            <i class="bi bi-list"></i>
        </button>
        
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">
            <img src="assets/img/logoOficri2x2.png" alt="Logo OFICRI" width="30" height="30" class="d-inline-block align-top me-2">
            Sistema de Gesti√≥n OFICRI
        </a>
        
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <span class="nav-link px-3" id="userDisplay"><i class="bi bi-person-circle me-1"></i> <span id="userName">Juan Perez</span></span>
            </div>
        </div>
    </header>

    <div class="container-fluid p-0" style="overflow-x: hidden; max-width: 100%;">
        <div class="row g-0 w-100 mx-0">
            <!-- Sidebar / Men√∫ principal -->
            <nav id="sidebarMenu" class="col-sidebar d-md-block sidebar collapse">
                <div class="p-3" style="padding-top: 25px !important;">
                    <h5 class="mt-4">Men√∫ Principal</h5>
                </div>
                <div class="sidebar-main mt-3">
                    <ul class="menu-items">
                        <li class="menu-item">
                            <a href="#dashboard" class="nav-link active">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#usuarios" class="nav-link">
                                <i class="bi bi-people me-2"></i>
                                Gesti√≥n de Usuarios
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#roles" class="nav-link">
                                <i class="bi bi-person-badge me-2"></i>
                                Gesti√≥n de Roles
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#areas" class="nav-link">
                                <i class="bi bi-grid me-2"></i>
                                Gesti√≥n de √Åreas
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#documentos" class="nav-link">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Gesti√≥n de Documentos
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#registros" class="nav-link">
                                <i class="bi bi-journal-check me-2"></i>
                                Registros / Auditor√≠a
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#exportar" class="nav-link">
                                <i class="bi bi-download me-2"></i>
                                Exportar
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="mt-auto p-3">
                    <a href="#" class="nav-link-logout" id="btnLogout" onclick="logoutDirectly(event); return false;">
                        <i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesi√≥n
                    </a>
                </div>
            </nav>

            <!-- Contenido principal -->
            <main class="px-4" style="width: 100%; flex-grow: 1;">
                <div id="mainContent" class="mt-4">
                    <!-- Tarjetas de estad√≠sticas organizadas en fila como en la imagen -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>USUARIOS ACTIVOS</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>DOCUMENTOS PENDIENTES</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>√ÅREAS ACTIVAS</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de Control -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="admin-section-title">Panel de Control</h3>
                        <button class="btn btn-actualizar">
                            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="module-container">
                                <h4>Actividad Reciente</h4>
                                <p class="text-muted">Cargando actividad reciente...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="module-container">
                                <h4>Documentos Pendientes</h4>
                                <p class="text-muted">Cargando documentos pendientes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Importar el m√≥dulo sidebarToggle -->
    <script type="module">
        import sidebarToggle from '/src/utils/sidebarToggle.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el m√≥dulo sidebarToggle
            sidebarToggle.init({
                sidebarSelector: '#sidebarMenu',
                contentSelector: 'main',
                buttonSelector: '#menuToggle'
            });
            
            console.log('M√≥dulo sidebarToggle inicializado correctamente');
        });
    </script>
    
    <!-- Script de administraci√≥n simplificado -->
    <script type="module">
        import { initSessionUI } from '/src/utils/sessionUI.js';
        
        // Funci√≥n para cerrar sesi√≥n directamente sin depender del m√≥dulo UI
        window.logoutDirectly = async function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Cierre de sesi√≥n directo iniciado');
            
            // Obtener el bot√≥n que inici√≥ la acci√≥n
            const button = event ? event.currentTarget : document.getElementById('btnLogout');
            
            if (button) {
                // Cambiar el aspecto del bot√≥n
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cerrando sesi√≥n...';
                button.style.pointerEvents = 'none';
            }
            
            try {
                // Detener verificador si existe
                if (window.sessionManager && window.sessionManager.stopAuthChecker) {
                    window.sessionManager.stopAuthChecker();
                }
                
                // Limpiar localStorage y sessionStorage
                const keysToRemove = ['token', 'user', 'redirectionOccurred', 'session', 'sessionExpiry'];
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // Limpiar prefijos espec√≠ficos
                ['oficri_'].forEach(prefix => {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(prefix)) localStorage.removeItem(key);
                    });
                    Object.keys(sessionStorage).forEach(key => {
                        if (key.startsWith(prefix)) sessionStorage.removeItem(key);
                    });
                });
                
                // Limpiar cookies
                document.cookie.split(';').forEach(cookie => {
                    document.cookie = cookie.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
                });
                
                console.log('Limpieza de sesi√≥n completa');
                
                // Intentar llamar al servicio de autenticaci√≥n si est√° disponible
                try {
                    const authService = await import('/src/services/auth/authService.js');
                    if (authService && authService.logout) {
                        await authService.logout();
                        console.log('Logout del servicio de autenticaci√≥n exitoso');
                    }
                } catch (serviceError) {
                    console.warn('Error al usar servicio de autenticaci√≥n:', serviceError);
                }
                
                // Redirigir a la p√°gina de login
                console.log('Redirigiendo a la p√°gina de login...');
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            } finally {
                // Siempre redirigir sin importar si hubo error
                setTimeout(() => {
                    window.location.href = '/index.html?nocache=' + Date.now();
                }, 200);
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // Sistema de depuraci√≥n modificado para ser menos intrusivo
            console.log('üîç DEBUG ADMIN: P√°gina de administrador cargada');
            
            // Funci√≥n para crear el contenedor de depuraci√≥n
            function createDebugContainer() {
                const debugContainer = document.createElement('div');
                debugContainer.id = 'debugContainer';
                debugContainer.style.position = 'fixed';
                debugContainer.style.bottom = '0';
                debugContainer.style.left = '0';
                debugContainer.style.right = '0';
                debugContainer.style.height = '30px'; // Altura reducida
                debugContainer.style.maxHeight = '30px';
                debugContainer.style.overflowY = 'hidden';
                debugContainer.style.backgroundColor = 'rgba(0,0,0,0.7)';
                debugContainer.style.color = '#22ff22';
                debugContainer.style.padding = '5px 10px';
                debugContainer.style.zIndex = '9999';
                debugContainer.style.fontFamily = 'monospace';
                debugContainer.style.fontSize = '10px';
                debugContainer.style.transition = 'all 0.3s ease';
                debugContainer.style.display = 'flex';
                debugContainer.style.alignItems = 'center';
                debugContainer.style.justifyContent = 'space-between';
                
                // A√±adir bot√≥n para expandir
                const expandButton = document.createElement('button');
                expandButton.textContent = '‚ñ≤';
                expandButton.style.background = 'none';
                expandButton.style.border = 'none';
                expandButton.style.color = '#22ff22';
                expandButton.style.cursor = 'pointer';
                expandButton.style.marginLeft = 'auto';
                
                // A√±adir contenedor de mensajes
                const messagesContainer = document.createElement('div');
                messagesContainer.id = 'debugMessages';
                messagesContainer.style.flex = '1';
                messagesContainer.style.overflow = 'hidden';
                messagesContainer.style.whiteSpace = 'nowrap';
                messagesContainer.style.textOverflow = 'ellipsis';
                
                debugContainer.appendChild(messagesContainer);
                debugContainer.appendChild(expandButton);
                
                // Estado inicial
                let expanded = false;
                
                // Funci√≥n para alternar el estado
                expandButton.addEventListener('click', () => {
                    expanded = !expanded;
                    if (expanded) {
                        debugContainer.style.height = '300px';
                        debugContainer.style.maxHeight = '300px';
                        debugContainer.style.overflowY = 'auto';
                        messagesContainer.style.whiteSpace = 'normal';
                        messagesContainer.style.overflow = 'auto';
                        expandButton.textContent = '‚ñº';
                    } else {
                        debugContainer.style.height = '30px';
                        debugContainer.style.maxHeight = '30px';
                        debugContainer.style.overflowY = 'hidden';
                        messagesContainer.style.whiteSpace = 'nowrap';
                        messagesContainer.style.overflow = 'hidden';
                        expandButton.textContent = '‚ñ≤';
                    }
                });
                
                document.body.appendChild(debugContainer);
                return {container: debugContainer, messages: messagesContainer};
            }
            
            // Crear el contenedor de depuraci√≥n
            const {container: debugContainer, messages: debugMessages} = createDebugContainer();
            
            // Funci√≥n para mostrar mensajes de depuraci√≥n
            function debugLog(message) {
                console.log(`üîç DEBUG ADMIN: ${message}`);
                const logEntry = document.createElement('div');
                logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                logEntry.style.borderBottom = '1px solid #444';
                logEntry.style.paddingBottom = '3px';
                logEntry.style.marginBottom = '3px';
                debugMessages.appendChild(logEntry);
                
                // Actualizar tambi√©n el texto visible cuando est√° colapsado
                if (debugMessages.childNodes.length === 1) {
                    debugMessages.title = logEntry.textContent;
                }
            }
            
            debugLog('Iniciando verificaci√≥n de autenticaci√≥n');
            
            // Inicializar la gesti√≥n de sesi√≥n UI con el m√≥dulo centralizado
            const sessionManager = initSessionUI({
                logoutButtonSelector: '#btnLogout',
                userNameSelector: '#userName',
                authCheckInterval: 60000, // Verificar cada 1 minuto
                debugLogger: debugLog,
                onLogoutSuccess: () => {
                    debugLog('Sesi√≥n cerrada exitosamente, redirigiendo...');
                },
                onLogoutError: (error) => {
                    debugLog(`Error al cerrar sesi√≥n: ${error.message}`);
                    window.location.href = '/index.html?nocache=' + Date.now();
                }
            });
            
            // Iniciar verificaci√≥n de autenticaci√≥n
            sessionManager.initAuthentication(true)
                .then(isAuthenticated => {
                    if (isAuthenticated) {
                        debugLog('Usuario autenticado correctamente');
                    } else {
                        debugLog('Usuario no autenticado, redirigiendo...');
                    }
                })
                .catch(error => {
                    debugLog(`Error en verificaci√≥n de autenticaci√≥n: ${error.message}`);
                });
            
            // Guardar en window para acceso global
            window.sessionManager = sessionManager;
            
            debugLog('Inicializaci√≥n completa de la p√°gina de administrador');
        });
    </script>

    <!-- Scripts adicionales -->
    <script>
        // Funci√≥n para cargar las estad√≠sticas del dashboard
        async function cargarEstadisticasDashboard() {
            try {
                console.log("üîç DEBUG ADMIN: Cargando estad√≠sticas del dashboard...");
                
                // Obtener token de autenticaci√≥n de m√∫ltiples posibles ubicaciones
                let token = localStorage.getItem('auth_token') || 
                           localStorage.getItem('token') || 
                           sessionStorage.getItem('auth_token') || 
                           sessionStorage.getItem('token');
                           
                // Buscar tambi√©n con el prefijo oficri_
                if (!token) {
                    token = localStorage.getItem('oficri_token') || 
                            sessionStorage.getItem('oficri_token');
                }
                
                console.log("üîç DEBUG ADMIN: Token encontrado:", token ? "S√≠" : "No");
                
                if (!token) {
                    // Intentar obtener el token del m√≥dulo de autenticaci√≥n
                    try {
                        const authModule = await import('/src/services/auth/authService.js');
                        token = await authModule.getToken();
                        console.log("üîç DEBUG ADMIN: Token obtenido del servicio de autenticaci√≥n:", token ? "S√≠" : "No");
                    } catch (authError) {
                        console.log("üîç DEBUG ADMIN: Error al obtener token del servicio:", authError);
                    }
                }
                
                // Intentar primero el endpoint p√∫blico (sin autenticaci√≥n)
                try {
                    console.log("üîç DEBUG ADMIN: Intentando usar el endpoint p√∫blico...");
                    const publicResponse = await fetch('/api/dashboard/public-stats');
                    
                    if (publicResponse.ok) {
                        console.log("üîç DEBUG ADMIN: Endpoint p√∫blico accesible");
                        const data = await publicResponse.json();
                        console.log("üîç DEBUG ADMIN: Datos recibidos:", data);
                        
                        // Actualizar la interfaz con los datos recibidos
                        updateDashboardStats(data);
                        
                        // Si hay estad√≠sticas detalladas, mostrarlas
                        if (data.estadisticasDetalladas) {
                            mostrarEstadisticasDetalladas(data.estadisticasDetalladas);
                        }
                        
                        return; // Salir de la funci√≥n si el endpoint p√∫blico funciona
                    } else {
                        console.log("üîç DEBUG ADMIN: Endpoint p√∫blico no accesible, c√≥digo:", publicResponse.status);
                    }
                } catch (publicError) {
                    console.log("üîç DEBUG ADMIN: Error al acceder al endpoint p√∫blico:", publicError);
                }
                
                // Si el endpoint p√∫blico falla y tenemos token, intentar con el endpoint autenticado
                if (token) {
                    console.log("üîç DEBUG ADMIN: Intentando usar el endpoint autenticado...");
                    
                    // Verificar si el token ya tiene el prefijo Bearer
                    if (!token.startsWith('Bearer ')) {
                        token = 'Bearer ' + token;
                    }
                    
                    // Hacer la solicitud a la API autenticada
                    const response = await fetch('/api/dashboard/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': token,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log("üîç DEBUG ADMIN: Respuesta de la API autenticada:", response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Error al obtener estad√≠sticas: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("üîç DEBUG ADMIN: Datos recibidos:", data);
                    
                    // Actualizar la interfaz con los datos recibidos
                    updateDashboardStats(data);
                } else {
                    console.log("üîç DEBUG ADMIN: Sin token, no se puede acceder al endpoint autenticado");
                }
                
            } catch (error) {
                console.error("üîç DEBUG ADMIN: Error al cargar estad√≠sticas:", error);
            }
        }
        
        // Funci√≥n para actualizar las estad√≠sticas en el dashboard
        function updateDashboardStats(data) {
            // Seleccionar correctamente las tarjetas por su contenido
            const cards = document.querySelectorAll('.stat-card .card-body');
            
            // Actualizar √°reas activas
            const areaCard = Array.from(cards).find(card => card.querySelector('h3').textContent === '√ÅREAS ACTIVAS');
            if (areaCard) {
                const numberElement = areaCard.querySelector('.number');
                if (numberElement) {
                    numberElement.textContent = data.areasActivas || 0;
                    console.log("üîç DEBUG ADMIN: √Åreas activas actualizadas:", data.areasActivas);
                }
            }
            
            // Actualizar usuarios activos
            const usuariosCard = Array.from(cards).find(card => card.querySelector('h3').textContent === 'USUARIOS ACTIVOS');
            if (usuariosCard) {
                const numberElement = usuariosCard.querySelector('.number');
                if (numberElement) {
                    numberElement.textContent = data.usuariosActivos || 0;
                    console.log("üîç DEBUG ADMIN: Usuarios activos actualizados:", data.usuariosActivos);
                }
            }
            
            // Actualizar documentos pendientes
            const documentosCard = Array.from(cards).find(card => card.querySelector('h3').textContent === 'DOCUMENTOS PENDIENTES');
            if (documentosCard) {
                const numberElement = documentosCard.querySelector('.number');
                if (numberElement) {
                    numberElement.textContent = data.documentosPendientes || 0;
                    console.log("üîç DEBUG ADMIN: Documentos pendientes actualizados:", data.documentosPendientes);
                }
            }
        }
        
        // Funci√≥n para mostrar estad√≠sticas detalladas
        function mostrarEstadisticasDetalladas(estadisticas) {
            console.log("üîç DEBUG ADMIN: Mostrando estad√≠sticas detalladas");
            
            // Obtenemos los contenedores donde mostraremos los datos
            const modulesContainer = document.querySelectorAll('.module-container');
            
            // Contenedor de actividad reciente
            const actividadContainer = Array.from(modulesContainer).find(container => 
                container.querySelector('h4').textContent === 'Actividad Reciente');
                
            // Contenedor de documentos pendientes
            const documentosContainer = Array.from(modulesContainer).find(container => 
                container.querySelector('h4').textContent === 'Documentos Pendientes');
            
            // Mostrar actividad reciente si tenemos datos
            if (actividadContainer && estadisticas.actividadReciente && estadisticas.actividadReciente.length > 0) {
                let actividadHTML = '<div class="list-group">';
                
                estadisticas.actividadReciente.forEach(actividad => {
                    const fecha = new Date(actividad.fecha).toLocaleString();
                    const estado = actividad.exitoso ? 
                        '<span class="badge bg-success">Exitoso</span>' : 
                        '<span class="badge bg-danger">Fallido</span>';
                        
                    actividadHTML += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${actividad.Nombres} ${actividad.Apellidos}</h5>
                                <small>${fecha}</small>
                            </div>
                            <p class="mb-1">Inicio de sesi√≥n desde ${actividad.ip || 'IP desconocida'}</p>
                            <small>${actividad.info || 'Dispositivo desconocido'} ${estado}</small>
                        </div>
                    `;
                });
                
                actividadHTML += '</div>';
                actividadContainer.innerHTML = `<h4>Actividad Reciente</h4>${actividadHTML}`;
                console.log("üîç DEBUG ADMIN: Actividad reciente actualizada");
            } else if (actividadContainer) {
                actividadContainer.innerHTML = `
                    <h4>Actividad Reciente</h4>
                    <p class="text-muted">No hay actividad reciente disponible.</p>
                `;
            }
            
            // Mostrar documentos pendientes por √°rea si tenemos datos
            if (documentosContainer && estadisticas.documentosPorArea && estadisticas.documentosPorArea.length > 0) {
                let documentosHTML = '<div class="list-group">';
                
                estadisticas.documentosPorArea.forEach(area => {
                    documentosHTML += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${area.NombreArea}</h5>
                                <small>Documentos asignados</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${area.cantidad}</span>
                        </div>
                    `;
                });
                
                documentosHTML += '</div>';
                documentosContainer.innerHTML = `<h4>Documentos Pendientes</h4>${documentosHTML}`;
                console.log("üîç DEBUG ADMIN: Documentos por √°rea actualizados");
            } else if (documentosContainer) {
                documentosContainer.innerHTML = `
                    <h4>Documentos Pendientes</h4>
                    <p class="text-muted">No hay documentos pendientes disponibles.</p>
                `;
            }
            
            // Crear contenedor para √°reas m√°s activas si tenemos datos
            if (estadisticas.areasActividad && estadisticas.areasActividad.length > 0) {
                // Buscar primero si ya existe
                let areasContainer = document.getElementById('areasActividadContainer');
                
                if (!areasContainer) {
                    // Si no existe, crear un nuevo contenedor despu√©s de los m√≥dulos existentes
                    const rowContainer = documentosContainer ? documentosContainer.closest('.row') : null;
                    
                    if (rowContainer) {
                        areasContainer = document.createElement('div');
                        areasContainer.id = 'areasActividadContainer';
                        areasContainer.className = 'col-md-12 mt-4';
                        
                        // Crear el HTML para las √°reas m√°s activas
                        let areasHTML = `
                            <div class="module-container">
                                <h4>√Åreas M√°s Activas</h4>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>√Årea</th>
                                                <th>C√≥digo</th>
                                                <th>Tipo</th>
                                                <th>Documentos</th>
                                                <th>Usuarios</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        estadisticas.areasActividad.forEach(area => {
                            areasHTML += `
                                <tr>
                                    <td>${area.NombreArea}</td>
                                    <td>${area.CodigoIdentificacion || 'N/A'}</td>
                                    <td>${area.TipoArea || 'N/A'}</td>
                                    <td>${area.documentos}</td>
                                    <td>${area.usuarios}</td>
                                </tr>
                            `;
                        });
                        
                        areasHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                        
                        areasContainer.innerHTML = areasHTML;
                        rowContainer.parentNode.insertBefore(areasContainer, rowContainer.nextSibling);
                        console.log("üîç DEBUG ADMIN: √Åreas m√°s activas creadas");
                    }
                } else {
                    // Si ya existe, actualizar su contenido
                    let areasHTML = `
                        <div class="module-container">
                            <h4>√Åreas M√°s Activas</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>√Årea</th>
                                            <th>C√≥digo</th>
                                            <th>Tipo</th>
                                            <th>Documentos</th>
                                            <th>Usuarios</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    estadisticas.areasActividad.forEach(area => {
                        areasHTML += `
                            <tr>
                                <td>${area.NombreArea}</td>
                                <td>${area.CodigoIdentificacion || 'N/A'}</td>
                                <td>${area.TipoArea || 'N/A'}</td>
                                <td>${area.documentos}</td>
                                <td>${area.usuarios}</td>
                            </tr>
                        `;
                    });
                    
                    areasHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    areasContainer.innerHTML = areasHTML;
                    console.log("üîç DEBUG ADMIN: √Åreas m√°s activas actualizadas");
                }
            }
        }
        
        // Cargar estad√≠sticas al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üîç DEBUG ADMIN: Inicializando carga de estad√≠sticas");
            cargarEstadisticasDashboard();
            
            // Configurar el bot√≥n de actualizar para recargar las estad√≠sticas
            const btnActualizar = document.querySelector('.btn-actualizar');
            if (btnActualizar) {
                btnActualizar.addEventListener('click', () => {
                    console.log("üîç DEBUG ADMIN: Actualizando estad√≠sticas manualmente");
                    cargarEstadisticasDashboard();
                });
            }
        });
    </script>

    <script>
        console.log("üîç DEBUG ADMIN: P√°gina de administrador cargada");
        
        // C√≥digo para manejar el clic en el perfil de usuario
        document.addEventListener('DOMContentLoaded', () => {
            const userDisplayElement = document.getElementById('userDisplay');
            
            if (userDisplayElement) {
                console.log("üîç DEBUG ADMIN: Elemento de perfil de usuario encontrado, agregando event listener");
                
                // Hacer que el cursor sea pointer para indicar que es clickeable
                userDisplayElement.style.cursor = 'pointer';
                
                userDisplayElement.addEventListener('click', async () => {
                    try {
                        console.log("üîç DEBUG ADMIN: Clic en perfil de usuario detectado");
                        
                        // Intentar obtener el CIP del usuario desde localStorage o sessionStorage
                        const storedUser = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
                        const userCIP = storedUser.codigoCIP || storedUser.CodigoCIP || '12345678'; // Fallback al admin
                        
                        console.log("üîç DEBUG ADMIN: CIP de usuario encontrado:", userCIP);
                        
                        // Primero intentamos usar la API p√∫blica que creamos como alternativa
                        try {
                            console.log("üîç DEBUG ADMIN: Obteniendo perfil usando API p√∫blica");
                            const profileResponse = await fetch(`/api/usuarios/public-profile/${userCIP}`);
                            
                            if (profileResponse.ok) {
                                const profileData = await profileResponse.json();
                                console.log("üîç DEBUG ADMIN: Datos de perfil recibidos:", profileData);
                                
                                if (profileData.success && profileData.user) {
                                    renderProfileUI(profileData.user);
                                    return; // Salir si se pudo usar la API alternativa
                                } else {
                                    // Si hay √©xito pero no hay datos del usuario
                                    showProfileError("No se pudieron cargar los datos del perfil", "La respuesta del servidor no contiene datos de usuario v√°lidos.");
                                }
                            } else {
                                // Mostrar un mensaje de error apropiado seg√∫n el c√≥digo de estado
                                let errorMessage = "Error al cargar el perfil de usuario";
                                let errorDetails = `El servidor respondi√≥ con el c√≥digo de estado: ${profileResponse.status}`;
                                
                                // Intentar obtener m√°s informaci√≥n del error
                                try {
                                    const errorData = await profileResponse.json();
                                    console.log("üîç DEBUG ADMIN: Error de la API p√∫blica (JSON):", errorData);
                                    
                                    if (errorData.message) {
                                        errorDetails = errorData.message;
                                    }
                                    
                                    if (errorData.errorDetails) {
                                        errorDetails += ` (${errorData.errorDetails})`;
                                    }
                                } catch (parseError) {
                                    console.log("üîç DEBUG ADMIN: No se pudo parsear la respuesta de error como JSON");
                                    try {
                                        const textError = await profileResponse.text();
                                        console.log("üîç DEBUG ADMIN: Error de la API p√∫blica (texto):", textError);
                                        if (textError) {
                                            errorDetails = textError;
                                        }
                                    } catch (textError) {
                                        console.log("üîç DEBUG ADMIN: No se pudo leer la respuesta de error");
                                    }
                                }
                                
                                // Mostrar el error al usuario
                                showProfileError(errorMessage, errorDetails);
                            }
                        } catch (publicApiError) {
                            console.log("üîç DEBUG ADMIN: Error al usar la API p√∫blica:", publicApiError);
                            showProfileError("Error de conexi√≥n", "No se pudo conectar con el servidor para obtener los datos del perfil.");
                        }
                    } catch (error) {
                        console.error("üîç DEBUG ADMIN: Error al mostrar el perfil de usuario:", error);
                        
                        // Muestra un mensaje de error en la interfaz
                        const mainContent = document.querySelector('#mainContent') || 
                                           document.querySelector('main') || 
                                           document.querySelector('.main-content');
                        
                        if (mainContent) {
                            mainContent.innerHTML = `
                                <div class="container mt-4">
                                    <div class="alert alert-danger">
                                        <h4><i class="bi bi-exclamation-triangle"></i> Error al cargar el perfil</h4>
                                        <p>${error.message}</p>
                                        <button class="btn btn-secondary mt-3" onclick="location.reload()">
                                            <i class="bi bi-arrow-clockwise"></i> Reintentar
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });
                
                console.log("üîç DEBUG ADMIN: Event listener agregado al elemento de perfil de usuario");
            } else {
                console.error("üîç DEBUG ADMIN: No se encontr√≥ el elemento de perfil de usuario");
            }
        });

        // Funci√≥n para mostrar un error en la interfaz de perfil
        function showProfileError(title, message) {
            console.log(`üîç DEBUG ADMIN: Mostrando error de perfil: ${title} - ${message}`);
            
            const mainContent = document.querySelector('#mainContent') || 
                               document.querySelector('main') || 
                               document.querySelector('.main-content');
            
            if (mainContent) {
                // Guardar el contenido actual para poder restaurarlo
                if (!mainContent.getAttribute('data-original-content')) {
                    mainContent.setAttribute('data-original-content', mainContent.innerHTML);
                }
                
                mainContent.innerHTML = `
                    <div class="container mt-4">
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">${title}</h4>
                            <p>${message}</p>
                            <hr>
                            <p class="mb-0">Por favor, int√©ntelo de nuevo m√°s tarde o contacte al administrador del sistema.</p>
                        </div>
                        <div class="text-center mt-4">
                            <button class="btn btn-secondary" id="backToDashboard">
                                <i class="bi bi-arrow-left me-2"></i>Volver al Dashboard
                            </button>
                        </div>
                    </div>
                `;
                
                // Agregar evento al bot√≥n de volver
                const backButton = document.getElementById('backToDashboard');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        // Restaurar el contenido original
                        if (mainContent.getAttribute('data-original-content')) {
                            mainContent.innerHTML = mainContent.getAttribute('data-original-content');
                            // Recargar las estad√≠sticas
                            cargarEstadisticasDashboard();
                        }
                    });
                }
            }
        }

        // Funci√≥n para renderizar la UI del perfil
        function renderProfileUI(userData) {
            // Limpiar el contenido principal y preparar para mostrar el perfil
            const mainContent = document.querySelector('#mainContent') || 
                              document.querySelector('main') || 
                              document.querySelector('.main-content');
            
            if (mainContent) {
                // Guardar el contenido actual para poder restaurarlo
                if (!mainContent.getAttribute('data-original-content')) {
                    mainContent.setAttribute('data-original-content', mainContent.innerHTML);
                }
                
                // Convertir fecha si es necesario
                const lastAccessDate = typeof userData.UltimoAcceso === 'string' ? 
                    new Date(userData.UltimoAcceso).toLocaleString() : 
                    (userData.UltimoAcceso ? new Date(userData.UltimoAcceso).toLocaleString() : 'No disponible');
                
                // Preparar la secci√≥n de √∫ltimos accesos si existen
                let accesosHTML = '';
                if (userData.accesos && userData.accesos.length > 0) {
                    let accesosList = '';
                    userData.accesos.forEach(acceso => {
                        const fecha = new Date(acceso.FechaEvento).toLocaleString();
                        const exitoso = acceso.Exitoso ? 
                            '<span class="badge bg-success">Exitoso</span>' : 
                            '<span class="badge bg-danger">Fallido</span>';
                            
                        accesosList += `
                            <tr>
                                <td>${fecha}</td>
                                <td>${acceso.IPOrigen || 'No registrada'}</td>
                                <td>${acceso.DispositivoInfo || 'No disponible'}</td>
                                <td>${exitoso}</td>
                            </tr>
                        `;
                    });
                    
                    accesosHTML = `
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">√öltimos Accesos</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>IP</th>
                                                <th>Dispositivo</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${accesosList}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                mainContent.innerHTML = `
                    <div class="container mt-4 user-profile-container">
                        <h2 class="profile-title"><i class="bi bi-person-circle"></i> Mi Perfil</h2>
                        
                        <div class="row mt-4">
                            <!-- Tarjeta de informaci√≥n b√°sica -->
                            <div class="col-md-4">
                                <div class="card mb-4 profile-card">
                                    <div class="card-body text-center">
                                        <div class="profile-avatar mb-3">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <h4 class="card-title profile-name">${userData.Nombres} ${userData.Apellidos}</h4>
                                        <p class="text-muted profile-rank">${userData.Grado || 'Usuario'}</p>
                                        <div class="profile-role-badge">${userData.NombreRol || 'Usuario'}</div>
                                        <p class="text-muted profile-cip"><i class="bi bi-person-badge"></i> CIP: ${userData.CodigoCIP}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informaci√≥n detallada -->
                            <div class="col-md-8">
                                <div class="card profile-details-card">
                                    <div class="card-header profile-details-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Informaci√≥n Detallada</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <table class="table table-bordered profile-details-table m-0">
                                            <tbody>
                                                <tr>
                                                    <th class="profile-detail-label">Nombre Completo</th>
                                                    <td class="profile-detail-value">${userData.Nombres} ${userData.Apellidos}</td>
                                                </tr>
                                                <tr>
                                                    <th class="profile-detail-label">Grado</th>
                                                    <td class="profile-detail-value">${userData.Grado || 'No especificado'}</td>
                                                </tr>
                                                <tr>
                                                    <th class="profile-detail-label">√Årea</th>
                                                    <td class="profile-detail-value">${userData.NombreArea || 'No especificada'}</td>
                                                </tr>
                                                <tr>
                                                    <th class="profile-detail-label">Rol</th>
                                                    <td class="profile-detail-value">
                                                        ${userData.NombreRol || 'No especificado'}
                                                        ${userData.NombreRol === 'Administrador' ? '<br><small class="text-muted role-description">Control total del sistema</small>' : ''}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th class="profile-detail-label">√öltimo Acceso</th>
                                                    <td class="profile-detail-value">${lastAccessDate}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log("üîç DEBUG ADMIN: Perfil renderizado correctamente con estilos de UserProfile.css");
            }
        }
    </script>
</body>
</html> 