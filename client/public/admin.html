<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFICRI - Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/src/styles/main.css" rel="stylesheet">
    <link href="/src/styles/components/buttons.css" rel="stylesheet">
    <link href="/src/styles/components/forms.css" rel="stylesheet">
    <link href="/src/styles/components/tables.css" rel="stylesheet">
    <link href="/src/styles/layouts/admin.css" rel="stylesheet">
    <link href="/src/styles/components/sidebar.css" rel="stylesheet">
    <link href="/src/styles/pages/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Header / Navbar -->
    <header class="navbar navbar-dark sticky-top flex-md-nowrap p-0 shadow">
        <!-- Botón hamburguesa independiente visible en todas las resoluciones -->
        <button id="menuToggle" class="ms-2">
            <i class="bi bi-list"></i>
        </button>
        
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">
            <img src="assets/img/logoOficri2x2.png" alt="Logo OFICRI" width="30" height="30" class="d-inline-block align-top me-2">
            Sistema de Gestión OFICRI
        </a>
        
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <span class="nav-link px-3" id="userDisplay"><i class="bi bi-person-circle me-1"></i> <span id="userName">Juan Perez</span></span>
            </div>
        </div>
    </header>

    <div class="container-fluid p-0" style="overflow-x: hidden; max-width: 100%;">
        <div class="row g-0 w-100 mx-0">
            <!-- Sidebar / Menú principal -->
            <nav id="sidebarMenu" class="col-sidebar d-md-block sidebar collapse">
                <div class="p-3" style="padding-top: 25px !important;">
                    <h5 class="mt-4">Menú Principal</h5>
                </div>
                <div class="sidebar-main mt-3">
                    <ul class="menu-items">
                        <li class="menu-item">
                            <a href="#dashboard" class="nav-link active">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#usuarios" class="nav-link">
                                <i class="bi bi-people me-2"></i>
                                Gestión de Usuarios
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#roles" class="nav-link">
                                <i class="bi bi-person-badge me-2"></i>
                                Gestión de Roles
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#areas" class="nav-link">
                                <i class="bi bi-grid me-2"></i>
                                Gestión de Áreas
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#documentos" class="nav-link">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Gestión de Documentos
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#registros" class="nav-link">
                                <i class="bi bi-journal-check me-2"></i>
                                Registros / Auditoría
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="#exportar" class="nav-link">
                                <i class="bi bi-download me-2"></i>
                                Exportar
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="mt-auto p-3">
                    <a href="#" class="nav-link-logout" id="btnLogout" onclick="logoutDirectly(event); return false;">
                        <i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesión
                    </a>
                </div>
            </nav>

            <!-- Contenido principal -->
            <main class="px-4" style="width: 100%; flex-grow: 1;">
                <div id="mainContent" class="mt-4">
                    <!-- Tarjetas de estadísticas organizadas en fila como en la imagen -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>USUARIOS ACTIVOS</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>DOCUMENTOS PENDIENTES</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card h-100">
                                <div class="card-body text-center">
                                    <h3>ÁREAS ACTIVAS</h3>
                                    <div class="number">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de Control -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="admin-section-title">Panel de Control</h3>
                        <button class="btn btn-actualizar">
                            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="module-container">
                                <h4>Actividad Reciente</h4>
                                <p class="text-muted">Cargando actividad reciente...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="module-container">
                                <h4>Documentos Pendientes</h4>
                                <p class="text-muted">Cargando documentos pendientes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Importar el módulo sidebarToggle -->
    <script type="module">
        import sidebarToggle from '/src/utils/sidebarToggle.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el módulo sidebarToggle
            sidebarToggle.init({
                sidebarSelector: '#sidebarMenu',
                contentSelector: 'main',
                buttonSelector: '#menuToggle'
            });
            
            console.log('Módulo sidebarToggle inicializado correctamente');
        });
    </script>
    
    <!-- Script de administración simplificado -->
    <script type="module">
        import { initSessionUI } from '/src/utils/sessionUI.js';
        
        // Función para cerrar sesión directamente sin depender del módulo UI
        window.logoutDirectly = async function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Cierre de sesión directo iniciado');
            
            // Obtener el botón que inició la acción
            const button = event ? event.currentTarget : document.getElementById('btnLogout');
            
            if (button) {
                // Cambiar el aspecto del botón
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cerrando sesión...';
                button.style.pointerEvents = 'none';
            }
            
            try {
                // Detener verificador si existe
                if (window.sessionManager && window.sessionManager.stopAuthChecker) {
                    window.sessionManager.stopAuthChecker();
                }
                
                // Limpiar localStorage y sessionStorage
                const keysToRemove = ['token', 'user', 'redirectionOccurred', 'session', 'sessionExpiry'];
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // Limpiar prefijos específicos
                ['oficri_'].forEach(prefix => {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(prefix)) localStorage.removeItem(key);
                    });
                    Object.keys(sessionStorage).forEach(key => {
                        if (key.startsWith(prefix)) sessionStorage.removeItem(key);
                    });
                });
                
                // Limpiar cookies
                document.cookie.split(';').forEach(cookie => {
                    document.cookie = cookie.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
                });
                
                console.log('Limpieza de sesión completa');
                
                // Intentar llamar al servicio de autenticación si está disponible
                try {
                    const authService = await import('/src/services/auth/authService.js');
                    if (authService && authService.logout) {
                        await authService.logout();
                        console.log('Logout del servicio de autenticación exitoso');
                    }
                } catch (serviceError) {
                    console.warn('Error al usar servicio de autenticación:', serviceError);
                }
                
                // Redirigir a la página de login
                console.log('Redirigiendo a la página de login...');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
            } finally {
                // Siempre redirigir sin importar si hubo error
                setTimeout(() => {
                    window.location.href = '/index.html?nocache=' + Date.now();
                }, 200);
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // Sistema de depuración modificado para ser menos intrusivo
            console.log('🔍 DEBUG ADMIN: Página de administrador cargada');
            
            // Función para crear el contenedor de depuración
            function createDebugContainer() {
                const debugContainer = document.createElement('div');
                debugContainer.id = 'debugContainer';
                debugContainer.style.position = 'fixed';
                debugContainer.style.bottom = '0';
                debugContainer.style.left = '0';
                debugContainer.style.right = '0';
                debugContainer.style.height = '30px'; // Altura reducida
                debugContainer.style.maxHeight = '30px';
                debugContainer.style.overflowY = 'hidden';
                debugContainer.style.backgroundColor = 'rgba(0,0,0,0.7)';
                debugContainer.style.color = '#22ff22';
                debugContainer.style.padding = '5px 10px';
                debugContainer.style.zIndex = '9999';
                debugContainer.style.fontFamily = 'monospace';
                debugContainer.style.fontSize = '10px';
                debugContainer.style.transition = 'all 0.3s ease';
                debugContainer.style.display = 'flex';
                debugContainer.style.alignItems = 'center';
                debugContainer.style.justifyContent = 'space-between';
                
                // Añadir botón para expandir
                const expandButton = document.createElement('button');
                expandButton.textContent = '▲';
                expandButton.style.background = 'none';
                expandButton.style.border = 'none';
                expandButton.style.color = '#22ff22';
                expandButton.style.cursor = 'pointer';
                expandButton.style.marginLeft = 'auto';
                
                // Añadir contenedor de mensajes
                const messagesContainer = document.createElement('div');
                messagesContainer.id = 'debugMessages';
                messagesContainer.style.flex = '1';
                messagesContainer.style.overflow = 'hidden';
                messagesContainer.style.whiteSpace = 'nowrap';
                messagesContainer.style.textOverflow = 'ellipsis';
                
                debugContainer.appendChild(messagesContainer);
                debugContainer.appendChild(expandButton);
                
                // Estado inicial
                let expanded = false;
                
                // Función para alternar el estado
                expandButton.addEventListener('click', () => {
                    expanded = !expanded;
                    if (expanded) {
                        debugContainer.style.height = '300px';
                        debugContainer.style.maxHeight = '300px';
                        debugContainer.style.overflowY = 'auto';
                        messagesContainer.style.whiteSpace = 'normal';
                        messagesContainer.style.overflow = 'auto';
                        expandButton.textContent = '▼';
                    } else {
                        debugContainer.style.height = '30px';
                        debugContainer.style.maxHeight = '30px';
                        debugContainer.style.overflowY = 'hidden';
                        messagesContainer.style.whiteSpace = 'nowrap';
                        messagesContainer.style.overflow = 'hidden';
                        expandButton.textContent = '▲';
                    }
                });
                
                document.body.appendChild(debugContainer);
                return {container: debugContainer, messages: messagesContainer};
            }
            
            // Crear el contenedor de depuración
            const {container: debugContainer, messages: debugMessages} = createDebugContainer();
            
            // Función para mostrar mensajes de depuración
            function debugLog(message) {
                console.log(`🔍 DEBUG ADMIN: ${message}`);
                const logEntry = document.createElement('div');
                logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                logEntry.style.borderBottom = '1px solid #444';
                logEntry.style.paddingBottom = '3px';
                logEntry.style.marginBottom = '3px';
                debugMessages.appendChild(logEntry);
                
                // Actualizar también el texto visible cuando está colapsado
                if (debugMessages.childNodes.length === 1) {
                    debugMessages.title = logEntry.textContent;
                }
            }
            
            debugLog('Iniciando verificación de autenticación');
            
            // Inicializar la gestión de sesión UI con el módulo centralizado
            const sessionManager = initSessionUI({
                logoutButtonSelector: '#btnLogout',
                userNameSelector: '#userName',
                authCheckInterval: 60000, // Verificar cada 1 minuto
                debugLogger: debugLog,
                onLogoutSuccess: () => {
                    debugLog('Sesión cerrada exitosamente, redirigiendo...');
                },
                onLogoutError: (error) => {
                    debugLog(`Error al cerrar sesión: ${error.message}`);
                    window.location.href = '/index.html?nocache=' + Date.now();
                }
            });
            
            // Iniciar verificación de autenticación
            sessionManager.initAuthentication(true)
                .then(isAuthenticated => {
                    if (isAuthenticated) {
                        debugLog('Usuario autenticado correctamente');
                    } else {
                        debugLog('Usuario no autenticado, redirigiendo...');
                    }
                })
                .catch(error => {
                    debugLog(`Error en verificación de autenticación: ${error.message}`);
                });
            
            // Guardar en window para acceso global
            window.sessionManager = sessionManager;
            
            debugLog('Inicialización completa de la página de administrador');
        });
    </script>
</body>
</html> 