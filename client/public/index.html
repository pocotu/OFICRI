<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFICRI - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Importaciones de estilos desde los archivos de proyecto -->
    <link href="../src/styles/main.css" rel="stylesheet">
    <link href="../src/styles/components/buttons.css" rel="stylesheet">
    <link href="../src/styles/components/forms.css" rel="stylesheet">
    <link href="../src/styles/pages/login.css" rel="stylesheet">
    <link href="../src/styles/layouts/auth.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div id="authHeaderContainer" class="oficri-header">
        <div class="d-flex align-items-center justify-content-between w-100">
            <div class="d-flex align-items-center">
                <img src="assets/img/logoOficri2x2.png" alt="OFICRI" class="oficri-logo">
                <span class="d-none d-sm-inline ms-2 text-white fw-bold">OFICRI</span>
            </div>
            <div class="oficri-title">
                OFICINA DE CRIMINALÍSTICA CUSCO
            </div>
            <div>
                <img src="assets/img/logoPolicia2x2.png" alt="Policía Nacional del Perú" class="oficri-logo">
            </div>
        </div>
    </div>
    
    <!-- Page Content -->
    <div class="page-content">
        <div class="login-card">
            <div class="login-content">
                <img 
                    src="assets/img/logoOficri2x2.png" 
                    alt="Escudo OFICRI" 
                    class="login-logo"
                >
                <div class="login-title-container">
                    <div class="login-title">Sistema de Gestión OFICRI</div>
                </div>
            </div>
            
            <form id="loginForm">
                <div class="login-form-group">
                    <label class="login-label">CIP</label>
                    <div class="login-input-group">
                        <div class="input-icon">
                            <i class="bi bi-person"></i>
                        </div>
                        <input type="text" class="login-input" id="username" placeholder="Ingrese su CIP" pattern="^\d{6,8}$" title="Ingrese un código CIP válido (6-8 dígitos)" required>
                    </div>
                </div>
                
                <div class="login-form-group">
                    <label class="login-label">Contraseña</label>
                    <div class="login-input-group">
                        <div class="input-icon">
                            <i class="bi bi-lock"></i>
                        </div>
                        <input type="password" class="login-input" id="password" placeholder="Ingrese su contraseña" required>
                        <button type="button" class="password-toggle" id="togglePassword">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                </div>
                
                <div id="errorMessage" class="alert alert-danger d-none mt-3"></div>
                
                <button type="submit" class="login-button">
                    <i class="bi bi-arrow-right-circle"></i> Iniciar Sesión
                </button>
            </form>
        </div>
    </div>
    
    <!-- Footer -->
    <div id="authFooterContainer" class="oficri-footer">
        <div class="d-flex justify-content-center">
            <span>© 2024 OFICRI - Oficina de Criminalística Cusco</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Carga del módulo login -->
    <script type="module">
        import { initSessionUI } from '../src/utils/sessionUI.js';
        import * as authService from '../src/services/auth/authService.js';
        
        // Esperar a que el DOM esté cargado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página de login cargada');
            
            // Inicializar sessionUI sin verificación de autenticación automática
            initSessionUI({
                skipAuthCheck: true, // Importante: evitar verificación automática en página de login
                logoutButtonSelector: null // No hay botón de logout en la página de login
            });
            
            // Recuperar elementos del formulario
            const loginForm = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            
            // Si el formulario existe, agregar controlador de eventos
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar entrada
                    if (!usernameInput || !passwordInput) {
                        console.error('Elementos del formulario no encontrados');
                        showError('Error en el formulario. Por favor recarga la página.');
                        return;
                    }
                    
                    const username = usernameInput.value.trim();
                    const password = passwordInput.value.trim();
                    
                    if (!username) {
                        showError('Por favor ingresa tu número de CIP');
                        usernameInput.focus();
                        return;
                    }
                    
                    if (!password) {
                        showError('Por favor ingresa tu contraseña');
                        passwordInput.focus();
                        return;
                    }
                    
                    // Mostrar spinner y ocultar error
                    showLoading(true);
                    hideError();
                    
                    try {
                        console.log('Iniciando login para:', username);
                        
                        // Intentar login
                        const userData = await authService.login(username, password);
                        
                        console.log('Login exitoso:', userData);
                        
                        // El método login ya maneja la redirección
                    } catch (error) {
                        console.error('Error durante login:', error);
                        
                        let errorText = 'Error al iniciar sesión. Por favor intenta nuevamente.';
                        
                        if (error.message.includes('contraseña')) {
                            errorText = 'Credenciales incorrectas. Verifica tu CIP y contraseña.';
                        } else if (error.message.includes('conexión') || error.message.includes('servidor')) {
                            errorText = 'Error de conexión. Verifica tu internet e intenta nuevamente.';
                        }
                        
                        showError(errorText);
                        showLoading(false);
                    }
                });
            } else {
                console.error('Formulario de login no encontrado');
            }
            
            // Funciones auxiliares
            function showLoading(show) {
                if (loadingSpinner) {
                    loadingSpinner.style.display = show ? 'block' : 'none';
                }
                
                if (loginForm) {
                    const submitButton = loginForm.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = show;
                    }
                }
            }
            
            function showError(message) {
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.style.display = 'block';
                } else {
                    console.error('Elemento de error no encontrado');
                    alert(message);
                }
            }
            
            function hideError() {
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
            }
            
            // Configurar toggle de password
            const togglePassword = document.getElementById('togglePassword');
            
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    const icon = togglePassword.querySelector('i');
                    if (icon) {
                        icon.className = type === 'password' ? 'bi bi-eye-slash' : 'bi bi-eye';
                    }
                });
            }
        });
    </script>
</body>
</html> 